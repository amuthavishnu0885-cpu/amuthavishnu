<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Arulmigu Narayana Swamy Temple - Donation Portal (Cloud) v3</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=Noto+Sans+Tamil:wght@400;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Inter', sans-serif; }
    [lang="ta"] body, [lang="ta"] button, [lang="ta"] input, [lang="ta"] textarea, [lang="ta"] h1, [lang="ta"] h2, [lang="ta"] p, [lang="ta"] label { font-family: 'Noto Sans Tamil', sans-serif; }
    .glass-card { background: rgba(255,255,255,0.75); backdrop-filter: blur(8px); border-radius: 12px; padding: 1.25rem; box-shadow: 0 6px 18px rgba(0,0,0,0.12); }
    .no-scrollbar::-webkit-scrollbar { display:none; } .no-scrollbar { -ms-overflow-style:none; scrollbar-width:none; }
    @media print {
      /* keep page layout but hide everything except printable content windows we open */
      body * { visibility: visible; }
    }
  </style>
</head>
<body class="bg-orange-50 min-h-screen">

<div id="app" class="max-w-6xl mx-auto p-6">
  <header class="mb-6">
    <div class="header-image bg-[url('https://placehold.co/1200x200/E67E22/FFFFFF?text=.')] bg-cover bg-center h-40 rounded-lg relative">
      <div class="absolute inset-0 bg-black/0 flex items-center justify-center rounded-lg">
        <h2 id="header-title" class="text-white text-1xl md:text-4xl font-bold"><center>Arulmigu Narayana Swamy Temple Donation Portal </center>center></h2>
      </div>
    </div>
  </header>

  <nav class="mb-6 flex justify-between items-center no-print">
    <div class="flex gap-2">
      <button id="en-lang-btn" class="px-4 py-2 bg-orange-500 text-white rounded-md">English</button>
      <button id="ta-lang-btn" class="px-4 py-2 bg-green-600 text-white rounded-md">‡Æ§‡ÆÆ‡Æø‡Æ¥‡Øç</button>
    </div>
    <div>
      <a href="#" id="admin-login-link" class="text-sm font-medium text-orange-700">Admin Login</a>
    </div>
  </nav>

  <main>
     <!-- Scan to Pay (static) -->
<div class="glass-card p-6 md:p-8 text-center">
  <h3 class="text-xl font-bold mb-2" data-key="paymentTitle">Scan to Pay</h3>
  <img id="upi-qr" src="QR.png" alt="UPI QR code" class="mx-auto rounded-lg shadow-lg w-400 h-500 object-cover" />
  <p class="mt-3 text-sm" data-key="paymentInstructions">After payment, enter the UPI transaction id in the form.</p>
</div>
    
    <!-- Home -->
    <div id="home-page">
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
        <section class="glass-card">
          <h2 class="text-2xl font-bold mb-4">Make a Donation</h2>
          <form id="donation-form" class="space-y-3">
            <div><label class="block text-sm font-medium">Donor Name</label><input id="donorName" required placeholder="Enter full name" class="mt-1 block w-full p-2 border rounded-md"></div>
            <div><label class="block text-sm font-medium">Address</label><textarea id="address" rows="2" class="mt-1 block w-full p-2 border rounded-md" placeholder="Address (optional)"></textarea></div>
            <div><label class="block text-sm font-medium">Phone Number</label><input id="phone" type="tel" class="mt-1 block w-full p-2 border rounded-md" placeholder="Mobile number"></div>
            <div><label class="block text-sm font-medium">Email ID</label><input id="email" type="email" class="mt-1 block w-full p-2 border rounded-md" placeholder="Email (optional)"></div>
            <div><label class="block text-sm font-medium">Donation Amount (‚Çπ)</label><input id="amount" type="number" min="1" required class="mt-1 block w-full p-2 border rounded-md" placeholder="Enter amount"></div>
            <div><label class="block text-sm font-medium">UPI Transaction ID</label><input id="transactionId" class="mt-1 block w-full p-2 border rounded-md" placeholder="Enter transaction ID from UPI"></div>
            <div><label class="block text-sm font-medium">Date</label><input id="donationDate" type="date" class="mt-1 block w-full p-2 border rounded-md"></div>
            <button type="submit" class="w-full bg-green-600 text-white py-2 rounded-lg">Submit Donation</button>
          </form>
        </section>


          <div class="glass-card">
            <h3 class="text-xl font-bold mb-2">Explore More</h3>
            <div class="flex flex-col sm:flex-row gap-3">
              <button id="go-to-photos-btn" class="w-full bg-orange-500 text-white py-2 rounded-lg">üñº Temple Photos</button>
              <button id="go-to-events-btn" class="w-full bg-orange-500 text-white py-2 rounded-lg">‚ú® Special Days</button>
            </div>
          </div>
        </aside>
      </div>
    </div>

    <!-- Photos, Events, Admin (similar to previous) -->
    <div id="photos-page" class="hidden">
      <div class="glass-card mb-6">
        <div class="flex justify-between items-center mb-4">
          <h2 class="text-2xl font-bold">üñºÔ∏è Temple Photosüì∏</h2>
          <button class="back-to-home-btn bg-gray-500 text-white px-4 py-2 rounded-md">Back to Home</button>
        </div>
        <div id="main-gallery" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4"></div>
      </div>
    </div>

    <div id="events-page" class="hidden">
      <div class="glass-card mb-6">
        <div class="flex justify-between items-center mb-4">
          <h2 class="text-2xl font-bold">‚ú® Special Days</h2>
          <button class="back-to-home-btn bg-gray-500 text-white px-4 py-2 rounded-md">Back to Home</button>
        </div>
        <div id="main-events" class="space-y-4"></div>
      </div>
    </div>

    <div id="admin-view" class="hidden no-print">
      <div class="glass-card">
        <div class="flex justify-between items-center mb-4">
          <h2 class="text-2xl font-bold">Admin Dashboard</h2>
          <div class="flex gap-2 items-center">
            <button id="logout-btn" class="bg-red-500 text-white px-3 py-2 rounded-md">Logout</button>
          </div>
        </div>

        <div class="border-b mb-4">
          <nav class="flex gap-4">
            <button id="donors-tab-btn" class="px-3 py-2 bg-orange-100 rounded-md text-orange-700">Donors</button>
            <button id="photos-tab-btn" class="px-3 py-2 rounded-md">Upload Photos</button>
            <button id="events-tab-btn" class="px-3 py-2 rounded-md">Manage Events</button>
          </nav>
        </div>

        <div id="donors-content">
          <div class="flex justify-between items-center mb-3">
            <h3 class="font-semibold">Donors List</h3>
            <div class="flex gap-2">
              <button id="print-btn" class="bg-blue-500 text-white px-3 py-2 rounded-md">Print</button>
              <button id="export-btn" class="bg-green-500 text-white px-3 py-2 rounded-md">Export CSV</button>
            </div>
          </div>
          <div id="donors-print-area" class="overflow-x-auto bg-white rounded-lg shadow p-2">
            <table class="min-w-full text-left">
              <thead class="bg-gray-100">
                <tr><th class="p-2">Name</th><th class="p-2">Contact</th><th class="p-2">Amount</th><th class="p-2">Txn ID</th><th class="p-2">Actions</th></tr>
              </thead>
              <tbody id="donors-table-body"></tbody>
            </table>
          </div>
        </div>

        <div id="photos-content" class="hidden">
          <h3 class="font-semibold mb-2">Upload Photos</h3>
          <form id="photo-upload-form" class="flex gap-2 mb-4">
            <input id="photoFile" type="file" accept="image/*" class="p-2 border rounded-md" />
            <button type="submit" class="bg-orange-500 text-white px-4 py-2 rounded-md">Upload</button>
          </form>
          <p class="text-sm text-gray-600">Uploaded photos will show on the main gallery.</p>
        </div>

        <div id="events-content" class="hidden">
          <h3 class="font-semibold mb-2">Manage Events</h3>
          <form id="event-form" class="space-y-2 mb-4">
            <input id="eventDate" type="date" class="p-2 border rounded-md w-full" required />
            <textarea id="eventDescription" rows="3" class="p-2 border rounded-md w-full" placeholder="E.g., Vaikunta Ekadasi special"></textarea>
            <button type="submit" class="bg-orange-500 text-white px-4 py-2 rounded-md w-full">Add Event</button>
          </form>
          <div id="admin-events-list" class="space-y-2"></div>
          <p class="text-sm text-gray-600">Events are visible to all users.</p>
        </div>
      </div>
    </div>

  </main>

  <footer class="mt-6 text-center text-sm no-print">&copy; <span id="footer-year"></span> Arulmigu Narayana Swamy Temple</footer>
</div>

<!-- Alert & Password modals -->
<div id="alert-modal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50">
  <div class="bg-white rounded-lg p-6 max-w-sm text-center">
    <p id="alert-message" class="mb-4"></p>
    <button id="alert-ok-btn" class="bg-orange-500 text-white px-4 py-2 rounded-md">OK</button>
  </div>
</div>

<div id="password-modal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50">
  <div class="bg-white rounded-lg p-6 max-w-sm">
    <h3 class="text-lg font-bold mb-2">Admin Login</h3>
    <form id="password-form" class="space-y-3">
      <label class="block">Enter password:</label>
      <input id="admin-password" type="password" class="w-full p-2 border rounded-md" />
      <div class="flex justify-end gap-2">
        <button type="button" id="password-cancel-btn" class="px-4 py-2 bg-gray-300 rounded-md">Cancel</button>
        <button type="submit" class="px-4 py-2 bg-orange-500 text-white rounded-md">Login</button>
      </div>
    </form>
  </div>
</div>

<!-- Firebase + App Logic -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
  import { getDatabase, ref, push, onValue, remove, get } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";
  import { getStorage, ref as sref, uploadBytesResumable, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-storage.js";

  // ---------- PASTE YOUR FIREBASE CONFIG ----------
  const firebaseConfig = {
  apiKey: "AIzaSyC7AcMsWETrrEwQTqVYL_QqFMzepMog",
  authDomain: "donation-portal-f4b2b.firebaseapp.com",
  databaseURL: "https://donation-portal-f4b2b-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "donation-portal-f4b2b",
  storageBucket: "donation-portal-f4b2b.appspot.com",
  messagingSenderId: "1105454748967",
  appId: "1:1105454748967:web:aa9de7408b64d5d8cd28de"
};
  // -----------------------------------------------

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);
  const storage = getStorage(app);

  // small helpers
  const showAlert = (msg) => {
    document.getElementById('alert-message').textContent = msg;
    document.getElementById('alert-modal').classList.remove('hidden'); document.getElementById('alert-modal').classList.add('flex');
  };
  document.getElementById('alert-ok-btn').addEventListener('click', ()=> document.getElementById('alert-modal').classList.add('hidden'));

  // ---------- Add donation ----------
  document.getElementById('donation-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const data = {
      donorName: document.getElementById('donorName').value || '',
      address: document.getElementById('address').value || '',
      phone: document.getElementById('phone').value || '',
      email: document.getElementById('email').value || '',
      amount: document.getElementById('amount').value || '',
      transactionId: document.getElementById('transactionId').value || '',
      date: document.getElementById('donationDate').value || new Date().toISOString().slice(0,10)
    };
    try {
      await push(ref(db, 'donations'), data);
      showAlert('Donation saved to cloud.');
      e.target.reset();
    } catch (err) {
      showAlert('Error saving donation: ' + err.message);
    }
  });

  // ---------- Live donors -> admin table ----------
  const donorsTableBody = document.getElementById('donors-table-body');
  onValue(ref(db,'donations'), snapshot => {
    const data = snapshot.val();
    donorsTableBody.innerHTML = '';
    if (data) {
      Object.keys(data).forEach(key => {
        const d = data[key];
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="p-2 border">${escapeHtml(d.donorName||'')}<br><small>${escapeHtml(d.address||'')}</small></td>
          <td class="p-2 border">${escapeHtml(d.phone||'')}<br><small>${escapeHtml(d.email||'')}</small></td>
          <td class="p-2 border">‚Çπ${escapeHtml(d.amount||'')}</td>
          <td class="p-2 border">${escapeHtml(d.transactionId||'')}</td>
          <td class="p-2 border"><button data-key="${key}" class="delete-donation bg-red-500 text-white px-2 py-1 rounded">Delete</button></td>
        `;
        donorsTableBody.appendChild(tr);
      });
      document.querySelectorAll('.delete-donation').forEach(btn => {
        btn.addEventListener('click', () => {
          if (confirm('Delete this donation?')) remove(ref(db, 'donations/' + btn.dataset.key));
        });
      });
    } else {
      donorsTableBody.innerHTML = '<tr><td colspan="5" class="p-4 text-gray-500">No donations yet.</td></tr>';
    }
  });

  // ---------- Print function (fixed) ----------
  // This function pulls current donations once and opens a new window with
  // a printable HTML table. This avoids CSS print hiding issues.
  async function printDonations() {
    try {
      const snap = await get(ref(db,'donations'));
      const data = snap.val();
      let rows = '';
      if (data) {
        let i = 1;
        Object.values(data).forEach(d => {
          rows += `<tr>
            <td style="border:1px solid #ddd;padding:6px">${i++}</td>
            <td style="border:1px solid #ddd;padding:6px">${escapeHtml(d.donorName||'')}</td>
            <td style="border:1px solid #ddd;padding:6px">${escapeHtml(d.phone||'')}</td>
            <td style="border:1px solid #ddd;padding:6px">‚Çπ${escapeHtml(d.amount||'')}</td>
            <td style="border:1px solid #ddd;padding:6px">${escapeHtml(d.transactionId||'')}</td>
            <td style="border:1px solid #ddd;padding:6px">${escapeHtml(d.date||'')}</td>
          </tr>`;
        });
      } else {
        rows = `<tr><td colspan="6" style="padding:12px;text-align:center">No donations to print</td></tr>`;
      }

      const html = `
      <!doctype html>
      <html>
      <head>
        <meta charset="utf-8">
        <title>Donations - Print</title>
        <style>
          body{font-family: Arial, Helvetica, sans-serif; padding:20px}
          h1{font-size:20px;margin-bottom:10px}
          table{border-collapse: collapse; width:100%}
          th{border:1px solid #ddd;padding:8px;background:#f2f2f2;text-align:left}
        </style>
      </head>
      <body>
        <h1>Arulmigu Narayana Swamy Temple - Donations</h1>
        <table>
          <thead>
            <tr>
              <th>#</th><th>Name</th><th>Phone</th><th>Amount (‚Çπ)</th><th>Txn ID</th><th>Date</th>
            </tr>
          </thead>
          <tbody>
            ${rows}
          </tbody>
        </table>
      </body>
      </html>`;

      const w = window.open('', '_blank', 'width=900,height=700');
      w.document.open();
      w.document.write(html);
      w.document.close();
      // give browser a small time to render then print
      setTimeout(()=> { w.print(); /* w.close(); optionally close */ }, 600);
    } catch (e) {
      showAlert('Print failed: ' + e.message);
    }
  }

  document.getElementById('print-btn').addEventListener('click', printDonations);

  // ---------- Export CSV (unchanged) ----------
  document.getElementById('export-btn').addEventListener('click', async () => {
    try {
      const snap = await get(ref(db,'donations'));
      const data = snap.val();
      if (!data) { showAlert('No donations to export.'); return; }
      const rows = [['Donor Name','Address','Phone','Email','Amount','TxnID','Date']];
      Object.values(data).forEach(d => rows.push([d.donorName||'', d.address||'', d.phone||'', d.email||'', d.amount||'', d.transactionId||'', d.date||'']));
      const csv = rows.map(r => r.map(cell => `"${String(cell).replace(/"/g,'""')}"`).join(',')).join('\r\n');
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = 'donations.csv'; a.click();
      URL.revokeObjectURL(url);
    } catch (e) { showAlert('Export failed: ' + e.message); }
  });

  // ---------- Photos upload & gallery ----------
  document.getElementById('photo-upload-form').addEventListener('submit', (e) => {
    e.preventDefault();
    const file = document.getElementById('photoFile').files[0];
    if (!file) { showAlert('Select a photo first.'); return; }
    const path = `photos/${Date.now()}_${file.name}`;
    const storageRef = sref(storage, path);
    const uploadTask = uploadBytesResumable(storageRef, file);
    uploadTask.on('state_changed', null, err => showAlert('Upload failed: ' + err.message), async () => {
      const url = await getDownloadURL(uploadTask.snapshot.ref);
      await push(ref(db,'photos'), { url, name: file.name, uploadedAt: new Date().toISOString() });
      showAlert('Photo uploaded to cloud.');
    });
    e.target.reset();
  });
// render gallery
  onValue(ref(db,'photos'), snapshot => {
    const data = snapshot.val() || {};
    const gallery = document.getElementById('main-gallery');
    gallery.innerHTML = '';
    Object.values(data).forEach(p => {
      const img = document.createElement('img');
      img.src = p.url; img.alt = p.name || 'photo';
      img.className = 'w-full h-48 object-cover rounded-lg shadow';
      gallery.appendChild(img);
    });
    if (!Object.keys(data).length) gallery.innerHTML = '<p class="text-center col-span-full text-gray-500">No photos uploaded yet.</p>';
  });

  // ---------- Events add/render/delete ----------
  document.getElementById('event-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const data = { date: document.getElementById('eventDate').value, description: document.getElementById('eventDescription').value||'' };
    try { await push(ref(db,'events'), data); showAlert('Event added to cloud.'); e.target.reset(); } catch (err) { showAlert('Error: '+err.message); }
  });

  let latestEvents = {};
  onValue(ref(db,'events'), snap => {
    latestEvents = snap.val() || {};
    renderPublicEvents(); renderAdminEvents();
  });

  function renderPublicEvents() {
    const list = document.getElementById('main-events');
    const arr = Object.keys(latestEvents).map(k => ({ key:k, ...latestEvents[k] })).sort((a,b)=> new Date(a.date)-new Date(b.date));
    list.innerHTML = arr.length ? arr.map(e => `<div class="bg-white/60 p-3 rounded"><p class="font-bold text-orange-700">${escapeHtml(new Date(e.date).toLocaleDateString())}</p><p>${escapeHtml(e.description)}</p></div>`).join('') : '<p class="text-center text-gray-500">No events scheduled yet.</p>';
  }
  function renderAdminEvents() {
    const container = document.getElementById('admin-events-list');
    const arr = Object.keys(latestEvents).map(k => ({ key:k, ...latestEvents[k] })).sort((a,b)=> new Date(a.date)-new Date(b.date));
    container.innerHTML = arr.length ? arr.map(e => `<div class="flex items-start justify-between bg-white/70 p-3 rounded"><div><p class="font-bold text-orange-700">${escapeHtml(new Date(e.date).toLocaleDateString())}</p><p>${escapeHtml(e.description)}</p></div><div><button data-key="${e.key}" class="delete-event bg-red-500 text-white px-3 py-1 rounded">Delete</button></div></div>`).join('') : '<p class="text-gray-500">No events</p>';
    document.querySelectorAll('.delete-event').forEach(btn => {
      btn.addEventListener('click', ()=> {
        if (confirm('Delete this event?')) remove(ref(db,'events/'+btn.dataset.key)).then(()=> showAlert('Event deleted.'));
      });
    });
  }

  // ---------- Admin login/logout ----------
  const adminPassword = 'password123'; // change this for production
  document.getElementById('admin-login-link').addEventListener('click', (ev)=> { ev.preventDefault(); document.getElementById('password-modal').classList.remove('hidden'); document.getElementById('password-modal').classList.add('flex'); });
  document.getElementById('password-cancel-btn').addEventListener('click', ()=> document.getElementById('password-modal').classList.add('hidden'));
  document.getElementById('password-form').addEventListener('submit', (e)=> {
    e.preventDefault();
    const v = document.getElementById('admin-password').value;
    if (v === adminPassword) { document.getElementById('password-modal').classList.add('hidden'); showAdminView(); } else showAlert('Wrong password. Access denied.');
  });

  function showAdminView() {
    document.getElementById('home-page').classList.add('hidden');
    document.getElementById('photos-page').classList.add('hidden');
    document.getElementById('events-page').classList.add('hidden');
    document.getElementById('admin-view').classList.remove('hidden');
    showAdminTab('donors');
  }

  function logoutAdmin() {
    // hide admin and return to home
    document.getElementById('admin-view').classList.add('hidden');
    document.getElementById('home-page').classList.remove('hidden');
    // clear any sensitive UI if needed
  }
  document.getElementById('logout-btn').addEventListener('click', ()=> {
    logoutAdmin();
  });

  // admin tab switching
  function showAdminTab(name){
    document.getElementById('donors-content').classList.toggle('hidden', name!=='donors');
    document.getElementById('photos-content').classList.toggle('hidden', name!=='photos');
    document.getElementById('events-content').classList.toggle('hidden', name!=='events');
    ['donors-tab-btn','photos-tab-btn','events-tab-btn'].forEach(id=> document.getElementById(id).classList.remove('bg-orange-100','text-orange-700'));
    if (name==='donors') document.getElementById('donors-tab-btn').classList.add('bg-orange-100','text-orange-700');
    if (name==='photos') document.getElementById('photos-tab-btn').classList.add('bg-orange-100','text-orange-700');
    if (name==='events') document.getElementById('events-tab-btn').classList.add('bg-orange-100','text-orange-700');
  }
  document.getElementById('donors-tab-btn').addEventListener('click', ()=> showAdminTab('donors'));
  document.getElementById('photos-tab-btn').addEventListener('click', ()=> showAdminTab('photos'));
  document.getElementById('events-tab-btn').addEventListener('click', ()=> showAdminTab('events'));

  // navigation
  document.getElementById('go-to-photos-btn').addEventListener('click', ()=> { document.getElementById('home-page').classList.add('hidden'); document.getElementById('photos-page').classList.remove('hidden'); });
  document.getElementById('go-to-events-btn').addEventListener('click', ()=> { document.getElementById('home-page').classList.add('hidden'); document.getElementById('events-page').classList.remove('hidden'); });
  document.querySelectorAll('.back-to-home-btn').forEach(b => b.addEventListener('click', ()=> { document.getElementById('photos-page').classList.add('hidden'); document.getElementById('events-page').classList.add('hidden'); document.getElementById('home-page').classList.remove('hidden'); }));

  // wire print/export/photo buttons done earlier
  document.getElementById('photo-upload-form').addEventListener('submit', (e)=> e.preventDefault()); // already wired above

  // simple helper
  function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g, function(m){ return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]); }); }

  // footer
  document.getElementById('footer-year').textContent = new Date().getFullYear();

</script>
</body>
</html>













